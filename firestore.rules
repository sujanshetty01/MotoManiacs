rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // Existing Collections (Keep as-is)
    // ============================================
    
    // Users collection - users can only read/write their own data
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Events collection - public read, admin write
    match /events/{eventId} {
      allow read: if true; // Anyone can read events
      allow write: if isAuthenticated() && isAdmin();
    }
    
    // Bookings collection - users can read their own, admins can read all
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // ============================================
    // CMS Collections (Admin write only)
    // ============================================
    
    // CMS Pages - public read, admin write
    match /pages/{pageId} {
      allow read: if true; // Public pages
      allow write: if isAdmin(); // Only admins can edit pages
    }
    
    // Ecosystem Segments - public read, admin write
    match /ecosystemSegments/{segmentId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Vision & Mission - public read, admin write
    match /visionMission/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Institution Cards - public read, admin write
    match /institutionCards/{cardId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // Campus & Talent Collections
    // ============================================
    
    // Campus Registrations - anyone can create, admins can read/update
    match /campusRegistrations/{registrationId} {
      allow create: if true; // Any visitor can submit
      allow read: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Talent Submissions - anyone can create, admins can read/update
    match /talentSubmissions/{submissionId} {
      allow create: if true; // Any visitor can submit
      allow read: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Review Tasks - admin only
    match /reviewTasks/{taskId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ============================================
    // Superstore Collections
    // ============================================
    
    // Products - public read, admin write
    match /products/{productId} {
      allow read: if true; // Anyone can browse products
      allow write: if isAdmin(); // Only admins manage products
    }
    
    // Orders - users can read their own, create new; admins can read all
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin(); // Only admins update order status
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Arrive & Drive - Quick Book Collections
    // ============================================
    
    // Availability Slots - public read, admin write
    match /availabilitySlots/{slotId} {
      allow read: if true; // Anyone can see availability
      allow write: if isAdmin(); // Only admins manage slots
    }
    
    // Quick Bookings - users can read their own, create new; admins can read all
    match /quickBookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Default Deny
    // ============================================
    
    // Deny all other requests by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
